# AI Router CI Pipeline
# Standard: "Verify First" strategy

name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # 1. Verification Stage (Fast Fail)
  # Runs linting, unit tests, and resilience tests
  verify:
    runs-on: ubuntu-latest
    env:
      AI_ROUTER_ENV: test
      AI_ROUTER_API_KEY: test_secret_key_12345
      # Disable cloud fallback for deterministic tests
      ENABLE_OPENAI_FALLBACK: "0" 

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install ruff pytest anyio httpx pytest-timeout pytest-asyncio

    - name: Lint with Ruff
      run: |
        # Stop the build if there are Python syntax errors or undefined names
        ruff check . --output-format=github

    - name: Run Unit Tests
      run: |
        # Run standard unit tests
        python -m pytest tests/unit/ tests/routing/ tests/security/ -v

    - name: Run Resilience Tests (Chaos)
      run: |
        # Run chaos tests (isolated environment)
        python -m pytest tests/resilience/ -v

  # 2. Smoke Stage (Integration)
  # Runs only if Verify passes. Uses Docker Compose for E2E.
  smoke:
    needs: verify
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Prep env path for compose
        run: |
          set -euxo pipefail
          sudo mkdir -p /srv-2/secrets/ai-stack
          # Create fake secret file
          sudo tee /srv-2/secrets/ai-stack/ai-stack.env >/dev/null <<'E'
          # CI ENV
          E

      - name: Compose up
        run: |
          set -euxo pipefail
          # Build and start services
          docker compose -f docker-compose.yml up -d --build ai-router
          
          # Health check loop (timeout 60s)
          for i in {1..60}; do 
            if curl -fsS http://localhost:8082/healthz; then
              echo "Server is UP"
              break
            fi
            echo "Waiting for server..."
            sleep 1
          done
          
          # Verify healthz success
          curl -fsS http://localhost:8082/healthz

      - name: Run Smoke Tests (Endpoints)
        run: |
          set -euxo pipefail
          # Test Public Endpoint
          curl -v http://localhost:8082/healthz
          
          # Test Models Endpoint (Requires Auth)
          curl -v -H "X-API-Key: test_secret_key_12345" http://localhost:8082/v1/models
          
          # Test Classification Decision (Debug)
          curl -X POST http://localhost:8082/debug/router_decision \
            -H "Content-Type: application/json" \
            -d '{"prompt": "Hello world"}'

      - name: Collect logs on failure
        if: failure()
        run: |
          docker compose -f docker-compose.yml logs ai-router

      - name: Teardown
        if: always()
        run: docker compose -f docker-compose.yml down -v || true
